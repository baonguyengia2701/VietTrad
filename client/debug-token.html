<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Token Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        textarea { width: 100%; height: 100px; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Token Authentication Debug</h1>
        
        <div class="section">
            <h2>1. Check localStorage</h2>
            <button onclick="checkLocalStorage()">Check UserInfo in localStorage</button>
            <div id="localStorageResult" class="result"></div>
        </div>

        <div class="section">
            <h2>2. Test Login</h2>
            <input type="email" id="email" placeholder="Email" value="baonguyengia2701@gmail.com">
            <input type="password" id="password" placeholder="Password" value="">
            <button onclick="testLogin()">Test Login</button>
            <div id="loginResult" class="result"></div>
        </div>

        <div class="section">
            <h2>3. Test Order Creation</h2>
            <button onclick="testOrderCreation()">Test Create Order</button>
            <div id="orderResult" class="result"></div>
        </div>

        <div class="section">
            <h2>4. Test Headers</h2>
            <button onclick="testHeaders()">Test Authorization Headers</button>
            <div id="headersResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';

        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<pre>${JSON.stringify(message, null, 2)}</pre>`;
            element.className = `result ${isError ? 'error' : 'success'}`;
        }

        function checkLocalStorage() {
            const userInfo = localStorage.getItem('userInfo');
            if (userInfo) {
                try {
                    const parsed = JSON.parse(userInfo);
                    log('localStorageResult', {
                        found: true,
                        hasAccessToken: !!parsed.accessToken,
                        hasRefreshToken: !!parsed.refreshToken,
                        tokenPreview: parsed.accessToken ? parsed.accessToken.substring(0, 30) + '...' : 'No token',
                        userEmail: parsed.email,
                        isAdmin: parsed.isAdmin
                    });
                } catch (e) {
                    log('localStorageResult', { error: 'Failed to parse userInfo', raw: userInfo }, true);
                }
            } else {
                log('localStorageResult', { found: false, message: 'No userInfo in localStorage' }, true);
            }
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('userInfo', JSON.stringify(data));
                    log('loginResult', {
                        success: true,
                        user: data.email,
                        hasAccessToken: !!data.accessToken,
                        tokenPreview: data.accessToken ? data.accessToken.substring(0, 30) + '...' : 'No token'
                    });
                } else {
                    const error = await response.json();
                    log('loginResult', { success: false, error }, true);
                }
            } catch (error) {
                log('loginResult', { success: false, error: error.message }, true);
            }
        }

        async function testOrderCreation() {
            const userInfo = localStorage.getItem('userInfo');
            if (!userInfo) {
                log('orderResult', { error: 'No user info found. Please login first.' }, true);
                return;
            }

            const user = JSON.parse(userInfo);
            const token = user.accessToken;

            const sampleOrder = {
                orderItems: [{
                    product: "6835a5882e1006edec7b2fb6",
                    name: "Test Product",
                    image: "https://example.com/image.jpg",
                    price: 100000,
                    quantity: 1,
                    selectedVariant: {
                        title: "M√†u xanh",
                        size: "20cm x 100cm",
                        price: 0
                    }
                }],
                shippingInfo: {
                    fullName: "Test User",
                    email: "test@example.com",
                    phone: "0123456789",
                    address: "123 Test Street",
                    city: "Ho Chi Minh",
                    district: "District 1",
                    ward: "Ward 1",
                    note: "Test note"
                },
                paymentMethod: "cod",
                shippingMethod: "standard",
                itemsPrice: 100000,
                shippingPrice: 30000,
                discountPrice: 0,
                voucherCode: "",
                voucherDiscount: 0,
                totalPrice: 130000
            };

            try {
                console.log('Sending request with token:', token ? token.substring(0, 30) + '...' : 'No token');
                
                const response = await fetch(`${API_BASE}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(sampleOrder)
                });

                const responseData = await response.json();

                log('orderResult', {
                    status: response.status,
                    success: response.ok,
                    data: responseData,
                    sentToken: token ? token.substring(0, 30) + '...' : 'No token'
                }, !response.ok);

            } catch (error) {
                log('orderResult', { error: error.message }, true);
            }
        }

        async function testHeaders() {
            const userInfo = localStorage.getItem('userInfo');
            if (!userInfo) {
                log('headersResult', { error: 'No user info found. Please login first.' }, true);
                return;
            }

            const user = JSON.parse(userInfo);
            const token = user.accessToken;

            try {
                const response = await fetch(`${API_BASE}/users/profile`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const responseData = await response.json();

                log('headersResult', {
                    status: response.status,
                    success: response.ok,
                    data: responseData,
                    sentToken: token ? token.substring(0, 30) + '...' : 'No token'
                }, !response.ok);

            } catch (error) {
                log('headersResult', { error: error.message }, true);
            }
        }

        // Auto-check localStorage on page load
        window.onload = function() {
            checkLocalStorage();
        };
    </script>
</body>
</html> 